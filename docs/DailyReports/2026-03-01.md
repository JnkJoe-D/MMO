# 2026-03-01 开发日报

## Git Commit 快速复制区

```text
feat(Player/AnimSystem): 实现 RootMotion 闪避派生体系与动画底层对象池重构
1. Player: 扩充 `GlobalAnimationConfig` 与 `AnimSetEntry` 数据槽位，接入 `DodgeFront` 和 `DodgeBack` 动作配置。
2. Player (HFSM 分层微状态机): 新增 `GroundDodgeSubState`，在 `PlayerGroundState` 中拦截 `OnDashStarted`，根据摇杆输入方向派发前闪/后闪。
3. Player (手感调优): 深度还原ZZZ连拍手感。移除了闪避转冲刺必须长按 Shift 的硬性限制；现在只需在闪避的取消窗口内（倒数 0.7 秒阶段）有推摇杆动作，即可丝滑派生至 `GroundDashSubState`，彻底解放操作维度的僵硬感。
4. AnimSystem (架构脱水): 为应对复杂动作管理，大刀阔斧斩平 `StateBase`。剔除了与单一动画深度绑定的业务属性（`Length`、`IsLooping`、`NormalizedTime` 等）并按职责规范下放至 `AnimState` 子类，使得基类正式成为多端扩展（如混合树 MixerState）的纯粹架构柄。
5. AnimSystem (防逆向拉扯/对象池化): 发现由于单个动作状态实例复用导致的负向 RootMotion Delta 回放灾难。彻底摒弃 `AnimLayer` 内部旧式的 `<AnimationClip, AnimState>` 单例缓冲字典，全面革新为 `<AnimationClip, Stack<AnimState>>` 休眠栈对象池。
6. AnimSystem (RebuildPlayable 核心): 赋予所有状态机对象重塑底层节点的 `RebuildPlayable()` 换心手术能力。不论是极高频同帧派发，还是休眠态唤醒接管，保证每次调用的 `AnimationClipPlayable` 都是时间轴归零、绝对纯净无残留的幼苗，根治角色连闪时被回溯拉长距的顽疾。
```

## 工作概览
今日的开发工作跨越了从**上层手感打磨**到**底层架构抢修**的双轨路线。相比昨天的系统分层（微状态机容器建立），今天的侧重点更加深入内核，去解决因为系统越发成熟带来的边缘情况失效（RootMotion 叠加干扰）。
在业务层，我们为角色实装了带有《绝区零》原生调性的基于 RootMotion 的精准位面闪避（Dodge），打通了闪避接冲刺（Dash）的一体式流场，去掉了需要长时间扣死按键的反人类约束。
而在核心底层，为了支撑“高频连按同一个动作产生多重淡入淡出”这一高端操作，我们扒开了 Unity Playables 的内核限制，从字典覆盖走向了栈式池化（Stack Pool）。这堪称是控制枢纽有史以来最大的一次“洗髓”。

## 详细工作记录

### 1. ZZZ 风格前/后闪避录入
*   更新配置器与枚举 `DodgeType`，打通摇杆判定实现向后翻滚/向前滑步。
*   摒弃了原方案中的“施加物理速度”，决定百分百拥抱美术制品的 RootMotion 表现，仅在过程中施加极细微的缓动防死角自转补偿。

### 2. 闪避派生连招解禁
*   取消了对 `Dash` 按键的持续验证。原本代码逻辑如果识别到由于玩家手太快松开了 Shift，会硬生生掐断为 Jog，现在改为：只要摇杆在推着，闪避之后的窗口就强制平顺导入到极限滑步冲刺中！

### 3. StateBase 逻辑剥离与职责下放 (架构脱水)
*   以往的状态基类管得太宽，甚至包含了片段长度（`Length`）。我们将其完全剔除，让 `StateBase` 回归到一个只知晓“时间、权重和速度”的纯净 Playable 控制柄。专属的业务包袱现已安全着陆至 `AnimState`。

### 4. 革命式缓存对象池与逆向根运动免疫防御 (核心重构)
*   **重现痛点**：若采用同一个 `AnimState` 反复播放一个 RootMotion 的片段，底层 Unity 播放图状回滚游标（`Time=0`）时，会当即产生巨大的反向平移 Delta（倒抽回溯）。
*   **打破枷锁**：
    *   移除陈旧的 `_clipStateCache`。引入 `Stack<AnimState>` 对象池来统一管理退权待机的老动作。
    *   实现 `RebuildPlayable()`，不仅是控制维度时间清零，更是在底层管线“切断、销毁并于一帧内原位重建”底层节点，令 RootMotion 的解析引擎彻底失忆起步。
    *   **连闪自排布**：即便处于旧闪避发起到一半，新闪避操作接踵而至，由于出池必定获取独立的新复刻后代，“自己跟自己淡出过渡 (Self-Blending)”在我们的自研动作系统中变成了无瑕的现实。

## 遗留与计划
*   **评价**：经过这一轮极致深耕，基于地表的平面移动系统已然达成了**全方位、无死角的顶级自洽**。不论玩家怎样去按，怎样用最病态的频次发起冲击，底层 Playables 和缓存池都会稳如磐石。
*   **下一步**：基础地表位移封卷完毕。是时候考虑将火力延伸到更为庞大的模块上了——可能是搭建框架级的 `CombatSystem`（战斗架构）、引入针对悬空机制的精确判定，又或者是结合新搭建的 Guard 双向防重入逻辑向业务上层抛出接口。
