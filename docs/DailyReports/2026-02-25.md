# 2026-02-25 开发日报

## Git Commit 快速复制区

```text
feat(UI/Network): 贯通客户端登录注册完整交互，实现 UIManager 层级排序修复与 Protobuf 自动化工程
0.(补充)初步完成了HostUpdatePanel的正常工作流程、Login/Register/LoginBackGround的Panel的客户端逻辑
1. Network & Tool: 移除冗余的 Mock 生成代码。制作 `gen.bat` 自动化将 `.proto` 编译为 C# 代码，替换登录/注册协议包为真正的 `C2S_Login` / `C2S_Register`。
2. UI: 彻底解耦 `LoginModule`，将注册逻辑剥离为独立的 `RegisterModule`，实现登录与注册面板的平行覆盖交互。
3. UI: 抽象出底层 `LoginBackgroundModule`，确保全屏媒体层在切换登录/注册面板时保持连续播放。
4. UI: 解决 Canvas 层级 (`SortingOrder`) 始终为 0 的 Bug；修正了 `UIManager` 中 `Internal_Create` 与 `AddToLayer` 的时序倒置，并在 `UIView` 中强启 `overrideSorting = true`。
5. Tool: 定位并协助修复 `UiAutoBindWindow` 自动生成工具在层级改动后的空引用抛错问题，完善组件寻址鲁棒性。
```

## 工作概览
本日主要聚焦于**客户端网络层的 Protobuf 协议贯通**、**登录与注册模块的解耦重构**，以及**修复底层 UI 框架的渲染时序 Bug**。彻底打通了客户端发起真实 `Login/Register` 请求的所有通路，同时完成了复杂面板层级分离机制的实测。客户端的基础已足够支撑，下一步将完全转向服务端的网络联调。

## 详细工作记录

### 1. Protobuf 自动化与网络层
*   **弃用 Mock 代码**：彻底删除了手动伪造的 `GeneratedMessages.cs`，统一收归 Protobuf 协议标准。
*   **自动化批处理引擎**：编写了 `gen.bat` 脚本，支持循环拉取 `Assets/GameClient/Network/Proto` 目录下的 proto 文件并调用 `protoc.exe` 执行编译输出。包含了异常捕获、控制台彩色提示、旧文件清空等工程化细节。
*   **全真实报文对接**：在 `LoginModule` 与新创立的 `RegisterModule` 内部，成功组装基于 `MsgId.Login(0x0100)` 和 `MsgId.Register(0x0101)` 的数据包并发送至 TCP 频道。

### 2. 登录与注册 UI 解耦 (MVC 重构)
*   **RegisterModule**：为“注册功能”创建了完全独立的 `RegisterModel`、`RegisterView` 和 `RegisterModule` MVC 三板斧。实现了两次密码重复一致性前端校验、必填项拦截（新增 Email 字段验证）。
*   **UI 切换流转**：点击“注册”不再是状态机变动，而是直接 `UIManager.Instance.Open<RegisterModule>()` 并且由新面板遮盖。注册成功、或点击返回后，再反向 `Open<LoginModule>()` 以恢复焦点。

### 3. 底层多媒体隔离背景 (LoginBackground)
*   为了防止在登录界面与注册界面来回开关时打断炫酷视频或特效，单独开辟了 `LoginBackgroundModule` 控制纯净的全屏背景层（基于 `UILayer.Background`）。由 `HotUpdateModule` 加载结束时统一负责打开，后续各种 UI 开闭对它毫无影响。

### 4. UIManager 层级渲染拦截 Bug 修复
*   **定位时序漏洞**：修复了在 `OpenRoutine` 协程中，计算 Order 与创建 View 的顺序颠倒 Bug（旧逻辑在 View 为 null 时就算 order，导致全盘放弃）。
*   **强制 UGUI 分离**：给 `UIView.cs` 暴露了属性 `Canvas.overrideSorting = true`。确保被框架分配的 10, 20, 30 等顺序能摆脱父级节点的桎梏，真实映射到相机的渲染覆盖次序中。

### 5. UiAutoBindWindow 排错与优化
*   在剥离背景的修改中，因预制体（Prefab）层级结构剧变，引出了严重的 `NullReferenceException` 崩溃。通过调整生成器输出和正则替换规避嵌套 Bug，最终帮助开发者理解了依靠完整目录层级 (`transform.Find`) 的隐患。

## 遗留与计划
*   **客户端侧 UI 流转与协议请求已全部备齐！**
*   **下一阶段计划：** 需要转向**服务端工程**，处理对应的方法分发（`S2C_Login` / `S2C_Register`）与 MySQL 数据库储存交互。完成后进行双端数据连通测试，随即正式推进至大厅/选角流程。


---

# 2026-02-25 开发日报 (补充)

## Git Commit 快速复制区

```text
feat(UI/Scene): 实现全局网络等待遮罩与独立架构的场景混合加载流
1. UI: 抽象并实现 `NetWaitModule`，作为 `Layer.System` 极高层级的全局网络请求遮罩，由业务端显式调用与关闭。
2. Framework: 剥离 `GameRoot` 中对 UI 表现的耦合干扰，遵循 SRP 理清各个模块“什么时候弹 Loading”的控制权。
3. Scene: 重构 `SceneManager.ChangeScene` 为数据驱动模型。引入 `SceneTransitionParams` 参数结构，支持向前置依赖传递预装配资源（`RequiredAssets`）。
4. Scene: 扩充 `SceneEvents`，新增细粒度 `SceneLoadProgressEvent` 事件（附带 `LoadingText`），把传统的同地图加载改造为包含“清理旧场景 -> 读地图空壳 -> 并发预读受控实体资源 -> 初始化”的四段式商业级过场。
5. UI: 新建 `LoadingModule` 全屏加载面板。利用业务端主动拉起，并独立监听 `SceneChangeEndEvent` 实现自主销毁，打通场景跳转全流程视觉过渡。
```

## 工作概览
在打通登录网络流程后，今日后半部分主要聚焦于**网络请求全局防并发遮罩（NetWaitModule）**以及**客户端场景/资源重度混合加载架构（SceneManager/LoadingModule）**。修正了早期将 UI 控制权强行绑定在系统入口（GameRoot）的做法，采取“业务方按需呼叫 + 模块自主闭环销毁”的高内聚规范，完成了由单界面流转到全场景重载加载体验的闭环。

## 详细工作记录

### 1. 全局网络等待遮罩 (NetWaitModule)
*   为防止用户点击登录后狂点屏幕导致发送多个并发突发请求，设计了极高层级（`System Layer`）的 `NetWaitModule` 阻断输入区。
*   最初设想做成局部 `Widget`，但在架构分析对比后，维持独立 `UIModule` 以保证统一化层级覆盖（不受父级穿透）及跨模块复用的有效性。
*   考虑到框架非纯净环境需求，放弃对全局派发 `Update` 事件的依赖，转交 `UIView` 自身内置协程平移驱动遮罩的自旋反馈。

### 2. 场景与资源混合加载架构重构 (Loading Sequence)
*   **彻底重写 SceneManager**：打断纯调用 `YooAsset` 的单线场景载入策略，重写为**四段式异步阶段**：
    1.  `(0%~10%)`：预处理，彻底清理过往缓存资源；
    2.  `(10%~40%)`：读地图，引入新场景配置树；
    3.  `(40%~90%)`：重加载，并行获取核心表现实体清单（`RequiredAssets`）；
    4.  `(90%~100%)`：初始化与装配收尾。
*   **SceneTransitionParams 参数化**：改变传统的函数无脑重载堆砌，均从高内聚参数配置类传入。
*   **富文本动态进度事件**：重写 `SceneLoadProgressEvent` 原语，外层 Loading UI 借此解析更新详实文案（如“世界构建中...”），赋予更好的用户感知。

### 3. LoadingModule 的业务驱动与解耦
*   **清理 GameRoot**：斩断在根单例上监听底层流程去命令 UI 模块展示的不合理代码，维护游戏循环主体的纯粹度。
*   **确立方案一调用规范**：在 `LoginModule.cs`（实际业务）发出转场指令前，用 `UIManager.Instance.Open<LoadingModule>()` 掌握界面生命起点；同时保留 `LoadingModule` 自主听命 `SceneChangeEndEvent` 进行关闭自杀的闭环收尾。代码逻辑分工边界变清晰。
